<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>MyTown</title>
		<link rel="stylesheet" type="text/css" href="css.css" />
		<script type="text/javascript" src="js/jquery.js"></script>
		<script type="text/javascript" src="js/ajax.js"></script>		
		<script type="text/javascript" src="js/mytowns.js"></script>
		<script type="text/javascript" src="js/island.js"></script>
		<script type="text/javascript" src="js/buildings.js"></script>
		<script type="text/javascript" src="js/transport.js"></script>
		<script type="text/javascript" src="js/worldmaps.js"></script>
		<script type="text/javascript" src="js/equipment.js"></script>
		<script type="text/javascript" src="js/hero.js"></script>
	</head>
	<body>
		<table width="100%" align="center" cellpadding="0" cellspacing="0" border="0">
			<tr>
				<td width="50%" valign="top">
					<table width="100%" align="center" cellpadding="0" cellspacing="0" border="0">
						<tr>
							<td id="config">
								<table width="640" align="center" cellpadding="0" cellspacing="0" border="0">
									<tr>
										<td>
											<a href="config.html" target="_blank" class="AdminToolsLink2">[我的设置]</a>
											<a href="cookie.html" target="_blank" class="AdminToolsLink2">[重设Cookie]</a>											
										</td>
										<td>
											<input type="text" id="resources" />
											<input type="text" id="from_town_id" size="7" />
											<span>-&gt;</span>
											<input type="text" id="to_town_id" size="7" />
											<input type="button" id="transport" value=" 运送 " onclick="transport();" />																						
										</td>										
									</tr>
								</table>
							</td>							
						</tr>
						<tr>
							<td id="towns"></td>
						</tr>
					</table>
				</td>
				<td width="50%" valign="top">
					<table width="100%" align="center" cellpadding="0" cellspacing="0" border="0">
						<tr>
							<td id="messages"></td>							
						</tr>
						<tr>
           		            <td>
           		            	<table width="500" align="center" cellpadding="0" cellspacing="0" border="0">
           		            		<tr>
           		            			<td>
           		            				From：<input id="message_text_from" type="text" size="18" />                    		            
			           		                To：<input id="message_text_to" type="text" size="18" />                    		            
			           		                <input id="message_button_submit" type="button" value=" 提交 " onclick="postMessage();" />
			           		                <input id="message_button_clear" type="button" value=" 清空 " onclick="clearMessage();" />
           		            			</td>
           		            		</tr>
           		            		<tr>
			           	                <td>Subject：<input id="message_text_subject" type="text" size="66" /></td>
			           	            </tr>
			           	            <tr>
			           	                <td><textarea id="message_text_body" cols="58" rows="9"></textarea></td>
			           	            </tr>
           		            	</table>           		                
           		            </td>
           	            </tr>       	                       	            
           	            <tr>
							<td>&nbsp;</td>							
						</tr>
						<tr>
							<td id="ranks"></td>
						</tr>
						<tr>
							<td>&nbsp;</td>							
						</tr>
						<tr>
							<td id="heroes"></td>
						</tr>
						<tr>
							<td>&nbsp;</td>							
						</tr>
						<tr>
							<td id="equipment"></td>
						</tr>
						<tr>
							<td align="center" height="35">
								X&nbsp;<input type="text" id="x" size="7" />
								Y&nbsp;<input type="text" id="y" size="7" />
								<select id="message">
									<option value="0" selected="selected">不带消息</option>
									<option value="1">带消息</option>
								</select>						
								<input type="button" id="queryisland" value="查询坐标" onclick="getIsland();" />
								<input type="button" id="queryworldmaps" value="查询范围" onclick="getWorldMaps();" />
							</td>
						</tr>
						<tr>
							<td id="island"></td>							
						</tr>
						<tr>
							<td>&nbsp;</td>							
						</tr>
						<tr>
							<td id="worldmaps"></td>							
						</tr>
					</table>
				</td>
			</tr>	
		</table>	
		<script type="text/javascript">
			var MyTowns = [57971, 68274, 71071, 71989, 108094, 178718];			
			var MyMessages = new Array();
			//57971		hihua
			//68274 	hhh
			//71071		hhihua
			//71989		haha
			//108094	hhhhhh
			//178718	hihua6
			
			function getMyTowns() {
				for (var i = 0;i < MyTowns.length;i++)
					requestMyTowns(MyTowns[i], setMyTown);
					
				setTimeout("getMyTowns()", 30000);			
			}
			
			function getMyMessage() {
				requestMyMessages(setMyMessages);					
				setTimeout("getMyMessage()", 30000);			
			}
			
			function getMyRanks() {
				requestMyRanks(setMyRanks, "top_users");
				setTimeout("getMyRanks()", 60000);
			}
			
			function getMyHeroes() {
				requestMyRanks(setMyHeroes, "top_heroes");
				setTimeout("getMyHeroes()", 60000);
			}
			
			function getMyEquipment() {
				for (var i = 0;i < MyTowns.length;i++)
					requestMyEquipment(MyTowns[i], setMyEquipment);
					
				setTimeout("getMyEquipment()", 45000);
			}
			
			function getFinishTime(buildingQueues, buildingId, lines) {
				if (buildingQueues == null)
					return "";
				
				var finishTime = "";
				$.each(buildingQueues, function(idx, buildingQueue) {
					if (lines) {
						var linesEvents = buildingQueue.lines_events;
						if (linesEvents != null) {
							$.each(linesEvents, function(idx, linesEvent) {
								if (linesEvent.building_id == buildingId) {
									var date = new Date(linesEvent.finish_time * 1000);
									finishTime = date.pattern("yyyy-MM-dd HH:mm:ss");
								}
							});						
						}					
					} else {
						if (buildingQueue.building_id == buildingId) {
							var date = new Date(buildingQueue.finish_time * 1000);
							finishTime = date.pattern("yyyy-MM-dd HH:mm:ss");
						}
					}					
				});
				
				return finishTime;
			}
			
			function getBuildingDesc(buildings, buildingQueues) {
				var html = ""; 
				$.each(buildings, function(idx, building) {										
					if (building.building_type == 2 || building.building_type == 5 || building.building_type == 6 || building.building_type == 7 || building.building_type == 8) {
						var lines = building.lines;
						var i = 1;
						if (lines != null) {
							$.each(lines, function(idx, line) {	
								var status = line.status;
								if (status == "upgrading") {
									var finishTime = getFinishTime(buildingQueues, line.id, true);
									html += "<tr>";
									html += "<td width=\"55%\" height=\"25\">";
									html += getBuildingName(building.building_type);
									html += i;
									html += "&nbsp;正在升级&nbsp;";										
									html += "Lv" + line.level + " -> " + "Lv" + (line.level + 1);
									html += "</td>";
									html += "<td>" + finishTime + "</td>";
									html += "</tr>";
								}
								
								i++;
							});
						}						
					} else {
						var status = building.status;
						if (status == "upgrading") {
							var finishTime = getFinishTime(buildingQueues, building.id, false);
							html += "<tr>";
							html += "<td width=\"55%\" height=\"25\">";
							html += getBuildingName(building.building_type);							
							html += "&nbsp;正在升级&nbsp;";										
							html += "Lv" + building.level + " -> " + "Lv" + (building.level + 1);
							html += "</td>";
							html += "<td>" + finishTime + "</td>";
							html += "</tr>";
						}
						
						if (building.building_type == 12) {							
							var towers = building.towers;
							if (towers != null) {
								var arrays = [ 1, 1 ];
								$.each(towers, function(idx, tower) {
									status = tower.status;
									if (status == "upgrading") {
										var finishTime = getFinishTime(buildingQueues, tower.id, true);
										html += "<tr>";
										html += "<td width=\"55%\" height=\"25\">";
										html += getBuildingName(tower.type);
										if (tower.type == 16) {
											html += arrays[0];
											arrays[0]++;
										} else {
											html += arrays[1];
											arrays[1]++;
										}										
										html += "&nbsp;正在升级&nbsp;";										
										html += "Lv" + tower.level + " -> " + "Lv" + (tower.level + 1);
										html += "</td>";
										html += "<td>" + finishTime + "</td>";
										html += "</tr>";									
									}
								});
							}						
						}
					}
				});
				
				return html;
			}
			
			function getTrainingDesc(soldiers) {
				var html = ""; 
				$.each(soldiers, function(idx, soldier) {
					var training = soldier.training_queue;
					if (training != null) {
						var date = new Date(training.finish_time * 1000);
						var finishTime = date.pattern("yyyy-MM-dd HH:mm:ss");						
						html += "<tr>";
						html += "<td width=\"55%\" height=\"25\">";
						html += getSoldiersName(soldier.name);					
						html += "&nbsp;正在训练&nbsp;";										
						html += training.count;
						html += "</td>";
						html += "<td>" + finishTime + "</td>";
						html += "</tr>";					
					}									
				});
				
				return html;
			}
			
			function getBattleDesc(battleQueues) {
				var html = "";
				if (battleQueues != null) {
					$.each(battleQueues, function(idx, battle) {
						var date = new Date(battle.arrive_time * 1000);
						var finishTime = date.pattern("yyyy-MM-dd HH:mm:ss");					
						html += "<tr>";
						html += "<td width=\"55%\" height=\"25\">";
						html += "攻击&nbsp;";						
						if (battle.mission == 1) {							
							html += battle.to_town_id + "&nbsp;" + battle.to_town_name;
							html += "(" + battle.to_x + "," + battle.to_y + ")" + "&nbsp;";
							html += "Lv: " + battle.to_level + "&nbsp;";
							html += "途中";
						} else {			
							html += battle.from_town_id + "&nbsp;" + battle.from_town_name;
							html += "(" + battle.from_x + "," + battle.from_y + ")" + "&nbsp;";
							html += "Lv: " + battle.from_level + "&nbsp;";							
							html += "返回";							
						}
							
						html += "</td>";
						html += "<td>" + finishTime + "</td>";
						html += "</tr>";												
						
						var tmp = "<table align=\"left\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						tmp += "<tr height=\"25\">";
						var army = battle.army;						
						if (army != null && army.infantry != null)
							tmp += "<td width=\"100\">" + getSoldiersName("infantry") + ":&nbsp;" + army.infantry + "</td>";						
						
						if (army != null && army.scout != null)
							tmp += "<td width=\"100\">" + getSoldiersName("scout") + ":&nbsp;" + army.scout + "</td>";
							
						if (army != null && army.musketman != null)
							tmp += "<td width=\"100\">" + getSoldiersName("musketman") + ":&nbsp;" + army.musketman + "</td>";
							
						if (army != null && army.catapult != null)
							tmp += "<td width=\"100\">" + getSoldiersName("catapult") + ":&nbsp;" + army.catapult + "</td>";
							
						if (army != null && army.berserker != null)
							tmp += "<td width=\"100\">" + getSoldiersName("berserker") + ":&nbsp;" + army.berserker + "</td>";
							
						tmp += "</tr>";
						tmp += "<tr height=\"25\">";
						if (army != null && army.frigate != null)
							tmp += "<td width=\"100\">" + getSoldiersName("frigate") + ":&nbsp;" + army.frigate + "</td>";
							
						if (army != null && army.destroyer != null)
							tmp += "<td width=\"100\">" + getSoldiersName("destroyer") + ":&nbsp;" + army.destroyer + "</td>";
							
						if (army != null && army.pegasus != null)
							tmp += "<td width=\"100\">" + getSoldiersName("pegasus") + ":&nbsp;" + army.pegasus + "</td>";
							
						if (army != null && army.ironclad != null)
							tmp += "<td width=\"100\">" + getSoldiersName("ironclad") + ":&nbsp;" + army.ironclad + "</td>";
						
						if (battle.hero_id != null) {
							var hero = battle.hero_id;
							if (hero > 0)
								tmp += "<td width=\"100\">" + "英雄: " + hero + "</td>";
							else
								tmp += "<td width=\"100\">&nbsp;</td>";	
						} else
							tmp += "<td width=\"100\">&nbsp;</td>";						
						
						tmp += "</tr>";
						tmp += "</table>";
						if (tmp.length > 0) {
							html += "<tr>";
							html += "<td colspan=\"2\">";
							html += tmp;
							html += "</td>";
							html += "</tr>";
						}												 				
					});
				}				
				
				return html;			
			}
			
			function getTransportDesc(transportQueues) {
				var html = "";
				if (transportQueues != null) {
					$.each(transportQueues, function(idx, transport) {
						var date = new Date(transport.finish_time * 1000);
						var finishTime = date.pattern("yyyy-MM-dd HH:mm:ss");					
						html += "<tr>";
						html += "<td width=\"55%\" height=\"25\">";
						html += "运送&nbsp;";						
						if (transport.mission == 3) {
							html += transport.to_town_id + "&nbsp;" + transport.to_town_name + "&nbsp;";												
							html += "途中";
						} else {
							html += transport.from_town_id + "&nbsp;";
							html += "返回";
						}
							
						html += "</td>";
						html += "<td>" + finishTime + "</td>";
						html += "</tr>";
						
						if (transport.mission == 3) {
							var tmp = "";
							var army = transport.army;						
							if (army != null && army.infantry != null)
								tmp += getSoldiersName("infantry") + ":&nbsp;" + army.infantry + "&nbsp;&nbsp;";						
							
							if (army != null && army.scout != null)
								tmp += getSoldiersName("scout") + ":&nbsp;" + army.scout + "&nbsp;&nbsp;";
								
							if (army != null && army.musketman != null)
								tmp += getSoldiersName("musketman") + ":&nbsp;" + army.musketman + "&nbsp;&nbsp;";
								
							if (army != null && army.catapult != null)
								tmp += getSoldiersName("catapult") + ":&nbsp;" + army.catapult + "&nbsp;&nbsp;";
								
							if (army != null && army.frigate != null)
								tmp += getSoldiersName("frigate") + ":&nbsp;" + army.frigate + "&nbsp;&nbsp;";
								
							if (army != null && army.destroyer != null)
								tmp += getSoldiersName("destroyer") + ":&nbsp;" + army.destroyer + "&nbsp;&nbsp;";
							
							if (tmp.length > 0) {
								html += "<tr>";
								html += "<td colspan=\"2\">";
								html += tmp;
								html += "</td>";
								html += "</tr>";
							}
										
							tmp = "";							
							var resources = transport.resources;						
							if (resources != null && resources.wood != null)
								tmp += "木头" + ":&nbsp;" + resources.wood + "&nbsp;&nbsp;";						
							
							if (resources != null && resources.food != null)
								tmp += "食物" + ":&nbsp;" + resources.food + "&nbsp;&nbsp;";
								
							if (resources != null && resources.iron != null)
								tmp += "黑铁石" + ":&nbsp;" + resources.iron + "&nbsp;&nbsp;";
								
							if (resources != null && resources.marble != null)
								tmp += "大理石" + ":&nbsp;" + resources.marble + "&nbsp;&nbsp;";
								
							if (resources != null && resources.gold != null)
								tmp += "黄金" + ":&nbsp;" + resources.gold + "&nbsp;&nbsp;";
							
							if (tmp.length > 0) {
								html += "<tr>";
								html += "<td colspan=\"2\">";
								html += tmp;
								html += "</td>";
								html += "</tr>";							
							}							
						}						
					});	
				}
				
				return html;
			}			
			
			function getSoldiersName(soldierName) {
				if (soldierName == "infantry")
					return "铁剑士";
					
				if (soldierName == "scout")
					return "侦察兵";
										
				if (soldierName == "musketman")
					return "火枪手";
					
				if (soldierName == "catapult")
					return "投石车";
					
				if (soldierName == "frigate")
					return "强弩舰";
					
				if (soldierName == "destroyer")
					return "火炮舰";
					
				if (soldierName == "pegasus")
					return "投石舰";
					
				if (soldierName == "berserker")
					return "狂战士";
					
				if (soldierName == "ironclad")
					return "铁甲舰";
					
				return "";
			}
			
			function getBuildingName(buildingType) {
				switch (buildingType) {
					case 1:
						return "兵营";
						
					case 2:
						return "木头";
						
					case 3:
						return "仓库";
						
					case 4:
						return "港口";
						
					case 5:
						return "食物";
						
					case 6:
						return "大理石";
						
					case 7:
						return "黑铁";
						
					case 8:
						return "黄金";
						
					case 9:
						return "市场";
						
					case 10:
						return "市政厅";
						
					case 12:
						return "城墙";
						
					case 13:
						return "造船厂";
						
					case 14:
						return "地窖";
						
					case 16:
						return "箭塔";
						
					case 17:
						return "炮塔";
						
					case 18:
						return "指挥所";
						
					default:
						return "";										
				}
			}
						
			function setMyTown(json, townId) {
				var town = json.town;
				if (town == null)
					return;				
				
				var div = "towns";
				var buildings = town.buildings;
				var alliance = town.alliance;
				var resources = town.resources;
				var soldiers = town.soldiers;
				var heroInfo = town.hero_info;
				var battleQueues = town.battle_queue;
				var buildingQueues = town.building_queue;
				var transportQueues = town.transport_queue;
				var hero = town.hero_info;				
				var fleetQuota = -1;
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 4) {
						var property = building.property;
						if (property != null)
							fleetQuota = property.fleet_quota;
						
						return;											
					}								
				});
												
				html = "";
				html += "<table width=\"640\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"1\" class=\"Table1\">";
				html += "<tr>";
				html += "<td width=\"10%\" align=\"center\" valign=\"middle\">基本信息</td>";
				html += "<td width=\"40%\">";				
				html += "<table width=\"94%\" border=\"0\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-left:5px\">";				
				if (town.is_capital == true) {
					html += "<tr>";
					html += "<td align=\"left\" width=\"34%\" height=\"25\">用户名: </td>";
					html += "<td>" + town.owner + "</td>";        
					html += "</tr>";
				}
				
				html += "<tr>";								
				html += "<td align=\"left\" width=\"34%\" height=\"25\">城市名称: </td>";
				if (town.is_capital == true)			        
					html += "<td><a href=\"#\" onclick=\"setTransportTo(" + townId + ");return false;\" class=\"AdminToolsLink1\"><span style=\"color:#FF0000\">" + town.name + "</span></a></td>";
				else
					html += "<td><a href=\"#\" onclick=\"setTransportTo(" + townId + ");return false;\" class=\"AdminToolsLink1\">" + town.name + "</a></td>";
				 				        
				html += "</tr>";        
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">城市ID: </td>";
				html += "<td>" + town.id + "</td>";        
				html += "</tr>";
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">状态: </td>";				
				if (town.city_status == "normal")
					html += "<td>" + town.city_status + "</td>";
				else
					html += "<td style=\"color:#FF0000\">" + town.city_status + "</td>";
					        
				html += "</tr>";
				html += "<tr>";
				
				var resource_type = "";
				if (town.resource_type == 1)
					resource_type = "黄金";
					
				if (town.resource_type == 2)
					resource_type = "大理石";
					
				if (town.resource_type == 3)
					resource_type = "黑铁石";
				
				html += "<td align=\"left\" width=\"34%\" height=\"25\">资源类别: </td>";
				html += "<td>" + resource_type + "</td>";        
				html += "</tr>";
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">等级: </td>";
				html += "<td>" + town.level + "</td>";        
				html += "</tr>";
				html += "<tr>";
				
				var alliance_name = "";
				if (alliance != null)
					alliance_name = alliance.alliance_name;
				
				html += "<td align=\"left\" width=\"34%\" height=\"25\">联盟: </td>";
				html += "<td>" + alliance_name + "</td>";        
				html += "</tr>";
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">坐标: </td>";
				html += "<td>" + town.island_x + "," + town.island_y + "</td>";        
				html += "</tr>";												
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">维护量: </td>";
				html += "<td>" + town.presence_defenders + "</td>";        
				html += "</tr>";
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">侦察量: </td>";
				html += "<td>" + town.presence_scout + "</td>";        
				html += "</tr>";				
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">宝石: </td>";
				html += "<td>" + town.gems + "</td>";        
				html += "</tr>";											    			    
				html += "</table>";				
				html += "</td>";
				
				html += "<td width=\"10%\" align=\"center\" valign=\"middle\">资源</td>";
				html += "<td width=\"40%\" align=\"left\">";
								
				$.each(resources, function(idx, resource) {
					if (resource.resource_name == "wood") {							
						html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td valign=\"top\" align=\"center\">";							
						html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">木头</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\"><a href=\"#\" onclick=\"setTransport(" + townId + ", 'wood', " + resource.resource_count + ", " + fleetQuota + ");return false;\" class=\"AdminToolsLink1\">" + resource.resource_count + "</a>/" + resource.max_volume + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
						html += "</tr>";
						html += "<tr>";
												
						var tmp = "";							
						$.each(buildings, function(idx, building) {
							if (building.building_type == 2) {
								var lines = building.lines;
								$.each(lines, function(idx, line) {
									if (line.status == "upgrading")											
										tmp += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, line.id, true) + "\">" + line.level + "</span>&nbsp;&nbsp;";											
									else
										tmp += "<a href=\"#\" onclick=\"upgradeBuilding(" + line.id + ");return false;\" class=\"AdminToolsLink1\">" + line.level + "</a>&nbsp;&nbsp;";
								});						
							}								
						});
						
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">&nbsp;</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + tmp + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">&nbsp;</td>";							
						html += "</tr>";							
						html += "</table>";
						html += "</td>";
						html += "</tr>";
						html += "</table><br/>";
						return;						
					}
					
					if (resource.resource_name == "food") {							
						html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td valign=\"top\" align=\"center\">";							
						html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">食物</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\"><a href=\"#\" onclick=\"setTransport(" + townId + ", 'food', " + resource.resource_count + ", " + fleetQuota + ");return false;\" class=\"AdminToolsLink1\">" + resource.resource_count + "</a>/" + resource.max_volume + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
						html += "</tr>";
						html += "<tr>";
												
						var tmp = "";							
						$.each(buildings, function(idx, building) {
							if (building.building_type == 5) {
								var lines = building.lines;
								$.each(lines, function(idx, line) {
									if (line.status == "upgrading")											
										tmp += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, line.id, true) + "\">" + line.level + "</span>&nbsp;&nbsp;";											
									else
										tmp += "<a href=\"#\" onclick=\"upgradeBuilding(" + line.id + ");return false;\" class=\"AdminToolsLink1\">" + line.level + "</a>&nbsp;&nbsp;";
								});						
							}								
						});
						
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">&nbsp;</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + tmp + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">&nbsp;</td>";							
						html += "</tr>";							
						html += "</table>";
						html += "</td>";
						html += "</tr>";
						html += "</table><br/>";
						return;					
					}													
							
					if (town.resource_type == 1) {
						if (resource.resource_name == "gold") {
							html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							html += "<tr>";
							html += "<td valign=\"top\" align=\"center\">";							
							html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							html += "<tr>";
							html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">黄金</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"45%\"><a href=\"#\" onclick=\"setTransport(" + townId + ", 'gold', " + resource.resource_count + ", " + fleetQuota + ");return false;\" class=\"AdminToolsLink1\">" + resource.resource_count + "</a>/" + resource.max_volume + "</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
							html += "</tr>";
							
							var tmp = "";							
							$.each(buildings, function(idx, building) {
								if (building.building_type == 8) {
									var lines = building.lines;
									$.each(lines, function(idx, line) {
										if (line.status == "upgrading")											
											tmp += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, line.id, true) + "\">" + line.level + "</span>&nbsp;&nbsp;";											
										else
											tmp += "<a href=\"#\" onclick=\"upgradeBuilding(" + line.id + ");return false;\" class=\"AdminToolsLink1\">" + line.level + "</a>&nbsp;&nbsp;";
									});						
								}								
							});
																				
							html += "<tr>";
							html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">&nbsp;</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + tmp + "</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"30%\">&nbsp;</td>";							
							html += "</tr>";													
							html += "</table>";
							html += "</td>";
							html += "</tr>";
							html += "</table><br/>";							
							return;
						}							
					}
					
					if (town.resource_type == 2) {
						if (resource.resource_name == "marble") {
							html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							html += "<tr>";
							html += "<td valign=\"top\" align=\"center\">";							
							html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							html += "<tr>";
							html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">大理石</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"45%\"><a href=\"#\" onclick=\"setTransport(" + townId + ", 'marble', " + resource.resource_count + ", " + fleetQuota + ");return false;\" class=\"AdminToolsLink1\">" + resource.resource_count + "</a>/" + resource.max_volume + "</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
							html += "</tr>";	
							
							var tmp = "";							
							$.each(buildings, function(idx, building) {
								if (building.building_type == 6) {
									var lines = building.lines;
									$.each(lines, function(idx, line) {
										if (line.status == "upgrading")											
											tmp += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, line.id, true) + "\">" + line.level + "</span>&nbsp;&nbsp;";											
										else
											tmp += "<a href=\"#\" onclick=\"upgradeBuilding(" + line.id + ");return false;\" class=\"AdminToolsLink1\">" + line.level + "</a>&nbsp;&nbsp;";
									});						
								}								
							});
									
							html += "<tr>";	
							html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">&nbsp;</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + tmp + "</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"30%\">&nbsp;</td>";							
							html += "</tr>";			
							html += "</table>";
							html += "</td>";
							html += "</tr>";
							html += "</table><br/>";
							return;
						}						
					}
					
					if (town.resource_type == 3) {
						if (resource.resource_name == "iron") {
							html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							html += "<tr>";
							html += "<td valign=\"top\" align=\"center\">";							
							html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							html += "<tr>";
							html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">黑铁石</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"45%\"><a href=\"#\" onclick=\"setTransport(" + townId + ", 'iron', " + resource.resource_count + ", " + fleetQuota + ");return false;\" class=\"AdminToolsLink1\">" + resource.resource_count + "</a>/" + resource.max_volume + "</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
							html += "</tr>";
							
							var tmp = "";							
							$.each(buildings, function(idx, building) {
								if (building.building_type == 7) {
									var lines = building.lines;
									$.each(lines, function(idx, line) {
										if (line.status == "upgrading")											
											tmp += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, line.id, true) + "\">" + line.level + "</span>&nbsp;&nbsp;";											
										else
											tmp += "<a href=\"#\" onclick=\"upgradeBuilding(" + line.id + ");return false;\" class=\"AdminToolsLink1\">" + line.level + "</a>&nbsp;&nbsp;";
									});						
								}								
							});
																			
							html += "<tr>";	
							html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">&nbsp;</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + tmp + "</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"30%\">&nbsp;</td>";							
							html += "</tr>";														
							html += "</table>";
							html += "</td>";
							html += "</tr>";
							html += "</table><br/>";
							return;							
						}							
					}
				});		
								
				$.each(resources, function(idx, resource) {
					if (town.resource_type != 1 && resource.resource_name == "gold") {			
						html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td valign=\"top\" align=\"center\">";							
						html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">黄金</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\"><a href=\"#\" onclick=\"setTransport(" + townId + ", 'gold', " + resource.resource_count + ", " + fleetQuota + ");return false;\" class=\"AdminToolsLink1\">" + resource.resource_count + "</a>/" + resource.max_volume + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
						html += "</tr>";																			
						html += "</table>";
						html += "</td>";
						html += "</tr>";
						html += "</table><br/>";							
						return;
					}
				
					if (town.resource_type != 2 && resource.resource_name == "marble") {
						html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td valign=\"top\" align=\"center\">";							
						html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">大理石</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\"><a href=\"#\" onclick=\"setTransport(" + townId + ", 'marble', " + resource.resource_count + ", " + fleetQuota + ");return false;\" class=\"AdminToolsLink1\">" + resource.resource_count + "</a>/" + resource.max_volume + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
						html += "</tr>";											
						html += "</table>";
						html += "</td>";
						html += "</tr>";
						html += "</table><br/>";
						return;
					}
					
					if (town.resource_type != 3 && resource.resource_name == "iron") {
						html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td valign=\"top\" align=\"center\">";							
						html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">黑铁石</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\"><a href=\"#\" onclick=\"setTransport(" + townId + ", 'iron', " + resource.resource_count + ", " + fleetQuota + ");return false;\" class=\"AdminToolsLink1\">" + resource.resource_count + "</a>/" + resource.max_volume + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
						html += "</tr>";																					
						html += "</table>";
						html += "</td>";
						html += "</tr>";
						html += "</table><br/>";
						return;							
					}				
				});			
								
				html += "</td>";
				html += "</tr>";
								
				var tr = true;				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 10) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<a href=\"#\" onclick=\"upgradeBuilding(" + building.id + ");return false;\" class=\"AdminToolsLink1\">" + getBuildingName(building.building_type) + "</a>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"92%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";			    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;						
			    	}					
				});
					
				$.each(buildings, function(idx, building) {
					if (building.building_type == 9) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<a href=\"#\" onclick=\"upgradeBuilding(" + building.id + ");return false;\" class=\"AdminToolsLink1\">" + getBuildingName(building.building_type) + "</a>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">售量: </td><td>" + property.left_capacity + "/" + property.capacity + "</td></tr>";			    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;						
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 3) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<a href=\"#\" onclick=\"upgradeBuilding(" + building.id + ");return false;\" class=\"AdminToolsLink1\">" + getBuildingName(building.building_type) + "</a>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">存量: </td><td>" + property.capacity + "</td></tr>";			    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 4) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<a href=\"#\" onclick=\"upgradeBuilding(" + building.id + ");return false;\" class=\"AdminToolsLink1\">" + getBuildingName(building.building_type) + "</a>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">运量: </td><td>" + property.fleet_quota + "/次</td></tr>";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">有效: </td><td>" + property.available_fleet + "次</td></tr>";			    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 1) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<a href=\"#\" onclick=\"upgradeBuilding(" + building.id + ");return false;\" class=\"AdminToolsLink1\">" + getBuildingName(building.building_type) + "</a>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">训练速度: </td><td>" + property.reduce_time_rate + "%</td></tr>";
			    		
			    		$.each(soldiers, function(idx, soldier) {
			    			var name = soldier.name;
			    			var count = soldier.count;
			    						    			
			    			if (name == "infantry" || name == "scout" || name == "musketman" || name == "catapult" || name == "berserker") {
			    				html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">" + getSoldiersName(name) + ": </td><td>" + count + "</td></tr>";
			    				return;			    			
			    			}			    			
			    		});
			    					    					    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 13) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<a href=\"#\" onclick=\"upgradeBuilding(" + building.id + ");return false;\" class=\"AdminToolsLink1\">" + getBuildingName(building.building_type) + "</a>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">训练速度: </td><td>" + property.reduce_time_rate + "%</td></tr>";
			    		
			    		$.each(soldiers, function(idx, soldier) {
			    			var name = soldier.name;
			    			var count = soldier.count;
			    			
			    			if (name == "frigate" || name == "destroyer" || name == "ironclad" || name == "pegasus") {
			    				html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">" + getSoldiersName(name) + ": </td><td>" + count + "</td></tr>";
			    				return;			    			
			    			}			    					    			
			    		});
			    					    					    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 12) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<a href=\"#\" onclick=\"upgradeBuilding(" + building.id + ");return false;\" class=\"AdminToolsLink1\">" + getBuildingName(building.building_type) + "</a>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td colspan=\"4\">" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    				    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">防御: </td><td colspan=\"4\">" + property.defense + "</td></tr>";
			    		
			    		var towers = building.towers;
			    		if (towers != null) {
			    			var arrays = [ 1, 1 ];
			    			$.each(towers, function(idx, tower) {
			    				var defense = tower.defense;
			    				var level = tower.level;
			    				var id = tower.id;
			    				var type = tower.type;
			    				var status = tower.status;
			    				var attack = tower.attack;
			    				var name = "";
			    				var tmp = "";
			    					
				    			if (tower.type == 16) {
				    				name = getBuildingName(tower.type);
				    				name += arrays[0];
				    				arrays[0]++;				    				
				    			}
				    			
				    			if (tower.type == 17) {
				    				name = getBuildingName(tower.type);
				    				name += arrays[1];
				    				arrays[1]++;				    				   			
				    			}
				    			
				    			if (status == "upgrading")
				    				tmp = "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, id, true) + "\">" + name + "</span>";			    			
				    			else
				    				tmp = "<a href=\"#\" onclick=\"upgradeBuilding(" + id + ");return false;\" class=\"AdminToolsLink1\">" + name + "</a>";
				    			
				    			html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">" + tmp + "</td><td width=\"15%\">攻击 </td><td>" + attack + "</td><td width=\"15%\">防御 </td><td>" + defense + "</td></tr>";				    			
				    			html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">" + type + "</td><td width=\"15%\">等级</td><td colspan=\"3\">" + level + "</td></tr>";				    			
				    		});
			    		}			    					    		
			    					    					    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 14) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<a href=\"#\" onclick=\"upgradeBuilding(" + building.id + ");return false;\" class=\"AdminToolsLink1\">" + getBuildingName(building.building_type) + "</a>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">存量: </td><td>" + property.safe_capacity + "</td></tr>";			    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 18) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<a href=\"#\" onclick=\"upgradeBuilding(" + building.id + ");return false;\" class=\"AdminToolsLink1\">" + getBuildingName(building.building_type) + "</a>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">加速: </td><td>" + property.accelerate_rate + "%</td></tr>";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">侦察: </td><td>" + property.available_line + "/" + property.spy_line + "</td></tr>";			    				    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				if (!tr)
					html += "<td width=\"10%\">&nbsp;</td><td width=\"40%\">&nbsp;</td></tr>";
				
				if (hero != null) {
					html += "<tr><td align=\"center\" height=\"25\">英雄</td>";
					html += "<td colspan=\"3\" align=\"left\">";
					var divHero = "hero_" + townId;
					if ($("body").find("#" + divHero).length > 0)
						html += $("#" + divHero).html();																					
					
					html += "</td></tr>";
				}									
					
				html += "<tr><td align=\"center\" height=\"25\">事件</td>";
				html += "<td colspan=\"3\" align=\"left\">";
				html += "<table width=\"97%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
												
				var desc = "";
				desc += getBuildingDesc(buildings, buildingQueues);
				desc += getTrainingDesc(soldiers);
				desc += getBattleDesc(battleQueues);
				desc += getTransportDesc(transportQueues);
				
				if (desc.length == 0)
					html += "<tr><td>&nbsp;</td></tr>";
				else
					html += desc;
								
				html += "</table>";
				html += "</td>";				
				html += "</table><br/>";
				
				var divTown = "town_" + townId;
				if ($("#" + div).find("#" + divTown).length == 0) {
					html = "<div id=\"" + divTown + "\">" + html + "</div>";
					$("#" + div).append(html);				
				} else
					$("#" + divTown).html(html);
					
				requestMyEquipment(townId, setMyEquipment);				
			}
			
			function setMyMessages(json) {
				var username = "";
				var tmp = "";					
				var type = -1;
				var sys = 0;
				var more = true;
				
				var messages = json.messages;
				if (messages != null) {
					$.each(messages, function(idx, message) {											
						var created_at = "";
						if (message.message_type != 5) {
							username = message.to;
							var date = new Date(message.created_at * 1000);
							created_at = date.pattern("yyyy-MM-dd HH:mm:ss");
						} else
							sys++;
						
						if (message.message_type != type) {
							tmp += "<table width=\"500\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							tmp += "<tr>";
							tmp += "<td align=\"left\">";
							tmp += getMessageType(message.message_type);
							tmp += "</td>";
							if (more) {
								tmp += "<td align=\"right\">";
								tmp += "<a href=\"messages.html?username=" + username + "&page=1\" target=\"_blank\" class=\"AdminToolsLink2\">[更多]</a>";
								tmp += "</td>";
								more = false;							
							}
							
							tmp += "</tr>";
							tmp += "</table>";
							type = message.message_type;
						}
						
						var found = false;
				        for (var i = 0;i < MyMessages.length;i++) {
				        	if (message.id == MyMessages[i]) {
				        		found = true;
				        		break;		          
				        	}  
				        }				        
				        
				        var bodyId = "body_" + message.id;
				        var contentId = "content_" + message.id;
				        if (message.message_type == 5)
				        	bodyId = "body_s" +  sys;        	 
						        												
						tmp += "<table width=\"500\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"1\" class=\"Table1\">";
						tmp += "<tr>";
						
						if (message.message_type != 5) {
							var mailId = 0;
							if (message.from == "Battle System")
								mailId = message.body;
								
							tmp += "<td width=\"70%\" height=\"30\" style=\"padding-left:5;padding-right:5\"><a href=\"#\" onclick=\"bodyShow('" + message.id + "', " + mailId + ");return false;\" class=\"AdminToolsLink1\">" + message.subject + "</a></td>";							
						} else
							tmp += "<td width=\"70%\" height=\"30\" style=\"padding-left:5;padding-right:5\"><a href=\"#\" onclick=\"bodyShow('s" + sys + "', 0);return false;\" class=\"AdminToolsLink1\">" + message.subject + "</a></td>";						
							
						var body = "";
				        var content = "";
				        if (message.body != null) {
				        	if (message.message_type != 5)      
				        		body = encodeURI(message.body);
				        		
				        	content = message.body;
				        	content = content.replace(/\n/g, "<br/>");			        	
				        }
				        	
						tmp += "<td rowspan=\"2\" align=\"center\">";
						tmp += "<table width=\"180\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						tmp += "<tr>";
												
						tmp += "<td align=\"center\" height=\"25\"><a href=\"#\" onclick=\"setMessage('" + message.from + "','" + message.to + "',&quot;" + message.subject + "&quot;,&quot;" + body + "&quot;);return false;\" class=\"AdminToolsLink1\">" + message.from + "</a> -> " + message.to + "</td>";
						tmp += "</tr>";
				        tmp += "<tr>";
				        tmp += "<td align=\"center\" height=\"25\">" + created_at + "</td>";
				        tmp += "</tr>";
				        tmp += "</table>";
				        tmp += "</td>";
				        tmp += "</tr>";
				        tmp += "<tr>";		            
				        tmp += "<td height=\"25\" style=\"padding-left:5;padding-right:5;\">" + message.to + "</td>";
				        tmp += "</tr>";
				        				        
				        if (!found)
				        	tmp += "<tr id=\"" + bodyId + "\" style=\"display:none\">";
				        else
				        	tmp += "<tr id=\"" + bodyId + "\">";				        				        		
				        
				        if (message.message_type != 5 && message.from == "Battle System") {
				        	var divBattle = "battle_" + message.id;
				        	if ($("body").find("#" + divBattle).length == 0)
								tmp += "<td id=\"" + contentId + "\" height=\"25\" style=\"padding-left:5;padding-right:5;padding-top:5;padding-bottom:5;\" colspan=\"2\">" + content + "</td>";		
							else {																	
								content = $("#" + divBattle).html();											
								tmp += "<td id=\"" + contentId + "\" height=\"25\" style=\"padding-left:5;padding-right:5;padding-top:5;padding-bottom:5;\" colspan=\"2\">" + content + "</td>";
							}				        					        
				        } else
				        	tmp += "<td id=\"" + contentId + "\" height=\"25\" style=\"padding-left:5;padding-right:5;padding-top:5;padding-bottom:5;\" colspan=\"2\">" + content + "</td>";
				        
				        tmp += "</tr>";
				        tmp += "</table>";
				        tmp += "<br />";	
					});
				}
				
				var html = tmp;									
			    $("#messages").html(html);				
			}
			
			function bodyShow(id, mailId) {
				var body = "#body_" + id;
				var content = "#content_" + id;				
				if (mailId > 0) {
					var divBattle = "battle_" + id;
					if ($("body").find("#" + divBattle).length == 0) {
						requestMyBattle(id, setBattle);				
					} else {												
						var html = $("#" + divBattle).html();
						$(content).html(html);
					}
				}				
						
				if ($(body).css("display") == "none") {												
					$(body).show();
					MyMessages.push(id);																											
				} else {
					$(body).hide();
					var index = -1;
			        for (var i = 0;i < MyMessages.length;i++) {
			        	if (id == MyMessages[i]) {
			        		index = i;
			        		break;		          
			        	}  
			        }
			        
			        if (index != -1)
			        	MyMessages.splice(index, 1);            			            
				}				
			}
			
			function setBattle(id, json) {							
				var html = "";
				var battleInfo = json.battle_info;
				if (battleInfo != null) {		
					var name = "&nbsp;";
					var attacker = battleInfo.attacker;
					if (attacker != null) {
						var town = attacker.town;
						if (town != null)
							name = town.name;					
					}
					
					var result = battleInfo.result;
					html += "<table width=\"60%\" align=\"left\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
					html += "<tr><td align=\"left\" valign=\"top\">";
					if (result != null) {
						html += "<table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr height=\"25\"><td width=\"25%\">" + name + "</td><td width=\"25%\">" + result.naval + "</td><td width=\"25%\">" + result.land + "</td><td width=\"25%\">" + result.total + "</td></tr>";
						html += "</table>";
					}
					
					html += "</td></tr>";
					html += "<tr><td align=\"left\">";
					
					var gotOrLose = battleInfo.got_or_lose;
					if (gotOrLose != null) {
						var resources = gotOrLose.resource;
						html += "<table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr><td width=\"50%\" align=\"left\" valign=\"top\">";
						if (resources != null) {
							html += "<table width=\"90%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							$.each(resources, function(idx, resource) {
								html += "<tr height=\"25\"><td>" + resource.name + "</td><td>" + resource.num + "</td></tr>";
							});
							
							html += "</table>";
						} else 
							html += "&nbsp;";
							
						html += "</td>";
						html += "<td width=\"50%\" align=\"left\" valign=\"top\">";
						var heros = gotOrLose.hero;
						if (heros != null) {
							html += "<table width=\"90%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							$.each(heros, function(idx, hero) {
								html += "<tr height=\"25\"><td>" + hero.name + "</td><td>" + hero.num + "</td></tr>";
							});
							
							html += "</table>";
						} else 
							html += "&nbsp;";
							
						html += "</td></tr>";
						html += "</table>";
					}
					
					html += "</td></tr>";
					html += "</table>";					
				}
				
				var divBattle = "battle_" + id;
				if ($("body").find("#" + divBattle).length == 0)
					$("body").append("<div id=\"" + divBattle + "\" style=\"display:none\">" + html + "</div>");			
				else
					$("#" + divBattle).html(html);
				
				var content = "#content_" + id;
				$(content).html(html);															
			}
			
			function getMessageType(type) {
				switch (type) {
					case 0:
						return "玩家";
						
					case 1:
						return "系统";
						
					case 3:
						return "战斗";
						
					case 5:
						return "新闻";
						
					default:
						return "";		
				}			
			}
			
			function setMyRanks(json) {
				var myrank = json.my_rank;
				var ranks = json.rank;
				if (ranks != null) {
					var flag = false;				
					var html = "<table width=\"500\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
					html += "<tr><td align=\"left\">玩家排行榜</td></tr>";					
					html += "</table>";
					html += "<table width=\"500\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"1\" class=\"Table1\">";										
					$.each(ranks, function(idx, rank) {						
						var color = "#000000";						
						if (myrank == rank.rank) {
							color = "#FF0000";
							flag = true;
						}
								
						html += "<tr>";
						html += "<td height=\"30\" width=\"40\" align=\"center\"><span style=\"color:" + color + "\">" + rank.rank + "</span></td>";
						html += "<td height=\"30\" width=\"60\" align=\"center\"><span style=\"color:" + color + "\">" + rank.id + "</span></td>";
						html += "<td height=\"30\" width=\"130\" align=\"center\"><span style=\"color:" + color + "\">" + rank.username + "</td>";						
						html += "<td height=\"30\" width=\"85\" align=\"center\"><span style=\"color:" + color + "\">" + rank.score + "</td>";	
						html += "<td height=\"30\" align=\"center\"><span style=\"color:" + color + "\">" + rank.alliance_name + "</td>";
						html += "</tr>";																										
					});
					
					if (!flag) {
						html += "<tr>";
						html += "<td height=\"30\" width=\"40\" align=\"center\"><span style=\"color:#FF0000\">" + json.my_rank + "</span></td>";
						html += "<td height=\"30\" width=\"60\" align=\"center\">&nbsp;</td>";
						html += "<td height=\"30\" width=\"130\" align=\"center\">&nbsp;</td>";
						html += "<td height=\"30\" width=\"85\" align=\"center\"><span style=\"color:#FF0000\">" + json.my_score + "</span></td>";
						html += "<td height=\"30\" align=\"center\">&nbsp;</td>";
						html += "</tr>";					
					}
															
					html += "</table>";					
					$("#ranks").html(html);					
				}			
			}
			
			function setMyHeroes(json) {
				var ranks = json.rank;
				if (ranks != null) {
					var flag = false;				
					var html = "<table width=\"500\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
					html += "<tr><td align=\"left\">英雄排行榜</td></tr>";					
					html += "</table>";
					html += "<table width=\"500\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"1\" class=\"Table1\">";										
					$.each(ranks, function(idx, rank) {						
						var color = "#000000";						
						if (rank.username == "hihua") {
							color = "#FF0000";
							flag = true;
						}
								
						html += "<tr>";
						html += "<td height=\"30\" width=\"40\" align=\"center\"><span style=\"color:" + color + "\">" + rank.rank + "</span></td>";
						html += "<td height=\"30\" width=\"75\" align=\"center\"><span style=\"color:" + color + "\">" + rank.id + "</span></td>";
						html += "<td height=\"30\" width=\"130\" align=\"center\"><span style=\"color:" + color + "\">" + rank.username + "</td>";						
						html += "<td height=\"30\" width=\"170\" align=\"center\"><span style=\"color:" + color + "\">" + rank.city_name + "</td>";	
						html += "<td height=\"30\" width=\"85\" align=\"center\"><span style=\"color:" + color + "\">" + rank.point + "</td>";
						html += "</tr>";																										
					});
					
					if (!flag) {
						html += "<tr>";
						html += "<td height=\"30\" width=\"40\" align=\"center\"><span style=\"color:#FF0000\">" + json.my_rank + "</span></td>";
						html += "<td height=\"30\" width=\"75\" align=\"center\">&nbsp;</td>";
						html += "<td height=\"30\" width=\"130\" align=\"center\">&nbsp;</td>";
						html += "<td height=\"30\" width=\"170\" align=\"center\">&nbsp;</td>";
						html += "<td height=\"30\" width=\"85\" align=\"center\"><span style=\"color:#FF0000\">" + json.hero_score + "</span></td>";
						html += "</tr>";					
					}
															
					html += "</table>";					
					$("#heroes").html(html);					
				}			
			}
			
			function setMyEquipment(townId, json) {
				setHero(json);
				var index = 0;				
				for (var i = 0;i < MyTowns.length;i++) {
					if (MyTowns[i] == townId) {
						index = i;
						break;
					}				
				}
												
				if (index == MyTowns.length - 1) {					
					var html = setEquipment(json);
					$("#equipment").html(html);
				}				
			}
			
			function getIsland() {
				var x = $("#x").val();
				var y = $("#y").val();
				
				if (x.length == 0 || y.length == 0)
					return;
					
				if (y.length == 1)
					y = "00" + y;
					
				if (y.length == 2)
					y = "0" + y;
					
				requestIsland(x, y, setIsland);
			}
			
			function setIsland(json) {
				var island = json.island;
				if (island == null)
					return;				
				
				var towns = island.towns;
				if (towns == null)
					return;				
								
				var total = 0;
				var html = "<table width=\"580\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"1\" class=\"Table1\">";										
													
				$.each(towns, function(idx, town) {
					total++;							
					if (town.type == "Town") {											
						var message = $("#message").val();						
						var href = "<a href=\"others.html?username=" + town.owner_name + "&town_id=" + town.id + "&user_id=" + town.owner_id + "&message=" + message + "\" target=\"_blank\" class=\"AdminToolsLink2\">" + town.owner_name + "</a>";
												
						html += "<tr>";
						html += "<td width=\"50\" height=\"30\" align=\"center\">" + town.id + "</td>";
						html += "<td width=\"120\" height=\"30\" align=\"center\">" + town.name + "</td>";
						html += "<td width=\"30\" height=\"30\" align=\"center\">" + town.level + "</td>";	
						html += "<td width=\"90\" height=\"30\" align=\"center\">" + href + "</td>";
						html += "<td width=\"60\" height=\"30\" align=\"center\">" + town.owner_id + "</td>";
						html += "<td width=\"140\" height=\"30\" align=\"center\">" + town.city_attack_level + "</td>";
						html += "<td width=\"40\" height=\"30\" align=\"center\">" + town.city_status + "</td>";
						html += "</tr>";		
					} else {
						var color = "#FF0000";						
						var date = new Date(town.finish_time * 1000);
						var dateTime = date.pattern("yyyy-MM-dd HH:mm:ss");
						
						html += "<tr>";
						html += "<td width=\"50\" height=\"30\" align=\"center\"><span style=\"color:" + color + "\">" + town.id + "</span></td>";
						html += "<td width=\"120\" height=\"30\" align=\"center\"><span style=\"color:" + color + "\">" + town.name + "</span></td>";
						html += "<td width=\"30\" height=\"30\" align=\"center\"><span style=\"color:" + color + "\">" + town.level + "</span></td>";	
						html += "<td width=\"90\" height=\"30\" align=\"center\">&nbsp;</td>";
						html += "<td width=\"60\" height=\"30\" align=\"center\">&nbsp;</td>";
						html += "<td width=\"140\" height=\"30\" align=\"center\"><span style=\"color:" + color + "\">" + dateTime + "</span></td>";
						html += "<td width=\"40\" height=\"30\" align=\"center\"><span style=\"color:" + color + "\">" + town.city_status + "</span></td>";
						html += "</tr>";
					}				
				});
				
				html += "</table>";			
				if (total > 0)
					$("#island").html(html);
			}
			
			function getWorldMaps() {
				var x = $("#x").val();
				var y = $("#y").val();
				
				if (x.length == 0 || y.length == 0)
					return;
					
				if (y.length == 1)
					y = "00" + y;
					
				if (y.length == 2)
					y = "0" + y;
					
				requestWorldMaps(x, y, setWorldMaps);														
			}
			
			function setWorldMaps(json) {
				var islands = json.islands;
				if (islands == null)
					return;
					
				var total = 0;
				var html = "<table width=\"500\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"1\" class=\"Table1\">";										
													
				$.each(islands, function(idx, island) {
					total++;
					var x = island.x.toString();
					var y = island.y.toString();
					var p = y;
															
					if (p.length == 1)
						p = "00" + p;
					
					if (p.length == 2)
						p = "0" + p;					
									
					var href = "<a href=\"#\" onclick=\"$('#x').val(" + x + ");$('#y').val(" + y + ");requestIsland('" + x + "', '" + p + "', setIsland);return false;\" class=\"AdminToolsLink2\">" + island.x + "," + island.y + "</a>";						
					var type = "";
					if (island.resource_type == 1)
						type = "黄金";
					
					if (island.resource_type == 2)
						type = "大理石";
						
					if (island.resource_type == 3)
						type = "黑铁石";
											
					html += "<tr>";
					html += "<td width=\"120\" height=\"30\" align=\"center\">" + href + "</td>";
					html += "<td width=\"120\" height=\"30\" align=\"center\">" + island.id + "</td>";
					html += "<td width=\"150\" height=\"30\" align=\"center\">" + type + "</td>";	
					html += "<td width=\"110\" height=\"30\" align=\"center\">" + island.town_count + "</td>";					
					html += "</tr>";								
				});
				
				html += "</table>";			
				if (total > 0)
					$("#worldmaps").html(html);
			}						
			
			function upgradeBuilding(buildingId) {
				if (window.confirm("是否升级"))
					requestBuildings(buildingId);
			}
			
			function setTransport(townId, resourcesName, resourcesCount, fleetQuota) {
				var total = resourcesCount;
				if (total > fleetQuota && fleetQuota != -1)
					total = fleetQuota;
					
				var resources = $("#resources").val();
				if (resources.length > 0)
					resources += "&";
					
				resources += resourcesName + "=" + total;
				$("#resources").val(resources);
				$("#from_town_id").val(townId);				
			}
			
			function setTransportTo(townId) {
				$("#to_town_id").val(townId);
			}
			
			function setTransportSuccess() {
				$("#resources").val("");
				alert("运送成功");		
			}
			
			function transport() {
				var fromTownId = $("#from_town_id").val();
				var toTownId = $("#to_town_id").val();
				var resources = $("#resources").val();
				if (fromTownId.length == 0 || toTownId.length == 0 || resources.length == 0)
					return;
				
				requestTransport(fromTownId, toTownId, resources, setTransportSuccess);			
			}					
			
			function setMessage(to, from, subject, body) {
				if (subject.length < 50)
			        subject = "Re:" + subject;
			
			    body = decodeURI(body);
			    if (body.length > 200)
			        body = body.substr(0, 200);
			   			    
			    $("#message_text_to").val(to);
			    $("#message_text_from").val(from);
			    $("#message_text_subject").val(subject);
			    $("#message_text_body").val(body);			
			}				
			
			function postMessage() {				
			    var to = $("#message_text_to").val();
			    var from = $("#message_text_from").val();
			    var subject = $("#message_text_subject").val();
			    var body = $("#message_text_body").val();
			
			    if (to == "" || from == "" || subject == "" || body == "") {
			        alert("发送Message失败");
			        return;
			    }
			
				to = encodeURIComponent(to);
			    from = encodeURIComponent(from);			    
			    subject = encodeURIComponent(subject);
			    body = encodeURIComponent(body);
			    
			    requestPostMyMessage(to, from, subject, body);
			}
			
			function clearMessage() {
				$("#message_text_to").val("");
			    $("#message_text_from").val("");
			    $("#message_text_subject").val("");
			    $("#message_text_body").val("");
			}
							
			getMyTowns();
			getMyMessage();
			getMyRanks();
			getMyHeroes();
			//getMyEquipment();
		</script>
	</body>
</html>