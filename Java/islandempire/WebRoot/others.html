<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Others</title>
		<link rel="stylesheet" type="text/css" href="css.css" />
		<script type="text/javascript" src="js/jquery.js"></script>
		<script type="text/javascript" src="js/ajax.js"></script>		
		<script type="text/javascript" src="js/others.js"></script>		
	</head>
	<body>
		<table width="100%" align="center" cellpadding="0" cellspacing="0" border="0">
			<tr>
				<td width="50%" valign="top">
					<table width="100%" align="center" cellpadding="0" cellspacing="0" border="0">						
						<tr>
							<td id="towns"></td>
						</tr>
					</table>
				</td>
				<td width="50%" valign="top">
					<table width="100%" align="center" cellpadding="0" cellspacing="0" border="0">
						<tr>
							<td id="messages"></td>							
						</tr>						
						<tr>
							<td>&nbsp;</td>							
						</tr>
						<tr>
							<td id="ranks"></td>
						</tr>
					</table>
				</td>
			</tr>	
		</table>	
		<script type="text/javascript">
			var Username = "";
			var UserId = "";
			var OtherTowns = [];
			var OtherMessages = new Array();
			 			
			function start() {
				Username = request.QueryString("username");
				UserId = request.QueryString("user_id");
				var townId = request.QueryString("town_id");
				var message = request.QueryString("message");
				getOthers(townId);
				
				if (message == "1")
					getOtherMessages(Username);
					
				//getOtherRanks();
			}			
			
			function getOthers(townId) {
				requestOthers(Username, townId, setOthers);
			}
			
			function setOthers(json) {
				var towns = json.towns;
				if (towns == null)
					return;
					
				$.each(towns, function(idx, town) {
					OtherTowns.push(town);					
				});
				
				if (OtherTowns.length > 0)
					getOtherTowns();
			}
			
			function getOtherTowns() {
				for (var i = 0;i < OtherTowns.length;i++)
					requestOtherTowns(Username, OtherTowns[i], setOtherTown);
						
				setTimeout("getOtherTowns()", 30000);		
			}
			
			function getOtherMessages() {
				requestOtherMessages(Username, 0, setOtherMessages);					
				setTimeout("getOtherMessages()", 30000);			
			}
			
			function getOtherRanks() {
				requestOtherRanks(Username, UserId, setOtherRanks);
				setTimeout("getOtherRanks()", 60000);
			}
			
			function getFinishTime(buildingQueues, buildingId, lines) {
				if (buildingQueues == null)
					return "";
				
				var finishTime = "";
				$.each(buildingQueues, function(idx, buildingQueue) {
					if (lines) {
						var linesEvents = buildingQueue.lines_events;
						if (linesEvents != null) {
							$.each(linesEvents, function(idx, linesEvent) {
								if (linesEvent.building_id == buildingId) {
									var date = new Date(linesEvent.finish_time * 1000);
									finishTime = date.pattern("yyyy-MM-dd HH:mm:ss");
								}
							});						
						}					
					} else {
						if (buildingQueue.building_id == buildingId) {
							var date = new Date(buildingQueue.finish_time * 1000);
							finishTime = date.pattern("yyyy-MM-dd HH:mm:ss");
						}
					}					
				});
				
				return finishTime;
			}
			
			function getBuildingDesc(buildings, buildingQueues) {
				var html = ""; 
				$.each(buildings, function(idx, building) {										
					if (building.building_type == 2 || building.building_type == 5 || building.building_type == 6 || building.building_type == 7 || building.building_type == 8) {
						var lines = building.lines;
						var i = 1;
						if (lines != null) {
							$.each(lines, function(idx, line) {	
								var status = line.status;
								if (status == "upgrading") {
									var finishTime = getFinishTime(buildingQueues, line.id, true);
									html += "<tr>";
									html += "<td width=\"55%\" height=\"25\">";
									html += getBuildingName(building.building_type);
									html += i;
									html += "&nbsp;正在升级&nbsp;";										
									html += "Lv" + line.level + " -> " + "Lv" + (line.level + 1);
									html += "</td>";
									html += "<td>" + finishTime + "</td>";
									html += "</tr>";
								}
								
								i++;
							});
						}						
					} else {
						var status = building.status;
						if (status == "upgrading") {
							var finishTime = getFinishTime(buildingQueues, building.id, false);
							html += "<tr>";
							html += "<td width=\"55%\" height=\"25\">";
							html += getBuildingName(building.building_type);							
							html += "&nbsp;正在升级&nbsp;";										
							html += "Lv" + building.level + " -> " + "Lv" + (building.level + 1);
							html += "</td>";
							html += "<td>" + finishTime + "</td>";
							html += "</tr>";
						}
						
						if (building.building_type == 12) {							
							var towers = building.towers;
							if (towers != null) {
								var arrays = [ 1, 1 ];
								$.each(towers, function(idx, tower) {
									status = tower.status;
									if (status == "upgrading") {
										var finishTime = getFinishTime(buildingQueues, tower.id, true);
										html += "<tr>";
										html += "<td width=\"55%\" height=\"25\">";
										html += getBuildingName(tower.type);
										if (tower.type == 16) {
											html += arrays[0];
											arrays[0]++;
										} else {
											html += arrays[1];
											arrays[1]++;
										}										
										html += "&nbsp;正在升级&nbsp;";										
										html += "Lv" + tower.level + " -> " + "Lv" + (tower.level + 1);
										html += "</td>";
										html += "<td>" + finishTime + "</td>";
										html += "</tr>";									
									}
								});
							}						
						}
					}
				});
				
				return html;
			}
			
			function getTrainingDesc(soldiers) {
				var html = ""; 
				$.each(soldiers, function(idx, soldier) {
					var training = soldier.training_queue;
					if (training != null) {
						var date = new Date(training.finish_time * 1000);
						var finishTime = date.pattern("yyyy-MM-dd HH:mm:ss");						
						html += "<tr>";
						html += "<td width=\"55%\" height=\"25\">";
						html += getSoldiersName(soldier.name);					
						html += "&nbsp;正在训练&nbsp;";										
						html += training.count;
						html += "</td>";
						html += "<td>" + finishTime + "</td>";
						html += "</tr>";					
					}									
				});
				
				return html;
			}
			
			function getBattleDesc(battleQueues) {
				var html = "";
				if (battleQueues != null) {
					$.each(battleQueues, function(idx, battle) {
						var date = new Date(battle.arrive_time * 1000);
						var finishTime = date.pattern("yyyy-MM-dd HH:mm:ss");					
						html += "<tr>";
						html += "<td width=\"55%\" height=\"25\">";
						html += "攻击&nbsp;";						
						if (battle.mission == 1) {							
							html += battle.to_town_id + "&nbsp;" + battle.to_town_name;
							html += "(" + battle.to_x + "," + battle.to_y + ")" + "&nbsp;";
							html += "Lv: " + battle.to_level + "&nbsp;";
							html += "途中";
						} else
							html += "返回";
							
						html += "</td>";
						html += "<td>" + finishTime + "</td>";
						html += "</tr>";												
						
						var tmp = "";
						var army = battle.army;						
						if (army != null && army.infantry != null)
							tmp += getSoldiersName("infantry") + ":&nbsp;" + army.infantry + "&nbsp;&nbsp;";						
						
						if (army != null && army.scout != null)
							tmp += getSoldiersName("scout") + ":&nbsp;" + army.scout + "&nbsp;&nbsp;";
							
						if (army != null && army.musketman != null)
							tmp += getSoldiersName("musketman") + ":&nbsp;" + army.musketman + "&nbsp;&nbsp;";
							
						if (army != null && army.catapult != null)
							tmp += getSoldiersName("catapult") + ":&nbsp;" + army.catapult + "&nbsp;&nbsp;";
							
						if (army != null && army.frigate != null)
							tmp += getSoldiersName("frigate") + ":&nbsp;" + army.frigate + "&nbsp;&nbsp;";
							
						if (army != null && army.destroyer != null)
							tmp += getSoldiersName("destroyer") + ":&nbsp;" + army.destroyer + "&nbsp;&nbsp;";
						
						if (tmp.length > 0) {
							html += "<tr>";
							html += "<td colspan=\"2\">";
							html += tmp;
							html += "</td>";
							html += "</tr>";
						}												 				
					});
				}				
				
				return html;			
			}
			
			function getTransportDesc(transportQueues) {
				var html = "";
				if (transportQueues != null) {
					$.each(transportQueues, function(idx, transport) {
						var date = new Date(transport.finish_time * 1000);
						var finishTime = date.pattern("yyyy-MM-dd HH:mm:ss");					
						html += "<tr>";
						html += "<td width=\"55%\" height=\"25\">";
						html += "运送&nbsp;";						
						if (transport.mission == 3) {
							html += transport.to_town_id + "&nbsp;" + transport.to_town_name + "&nbsp;";												
							html += "途中";
						} else
							html += "返回";
							
						html += "</td>";
						html += "<td>" + finishTime + "</td>";
						html += "</tr>";
						
						if (transport.mission == 3) {
							var tmp = "";
							var army = transport.army;						
							if (army != null && army.infantry != null)
								tmp += getSoldiersName("infantry") + ":&nbsp;" + army.infantry + "&nbsp;&nbsp;";						
							
							if (army != null && army.scout != null)
								tmp += getSoldiersName("scout") + ":&nbsp;" + army.scout + "&nbsp;&nbsp;";
								
							if (army != null && army.musketman != null)
								tmp += getSoldiersName("musketman") + ":&nbsp;" + army.musketman + "&nbsp;&nbsp;";
								
							if (army != null && army.catapult != null)
								tmp += getSoldiersName("catapult") + ":&nbsp;" + army.catapult + "&nbsp;&nbsp;";
								
							if (army != null && army.frigate != null)
								tmp += getSoldiersName("frigate") + ":&nbsp;" + army.frigate + "&nbsp;&nbsp;";
								
							if (army != null && army.destroyer != null)
								tmp += getSoldiersName("destroyer") + ":&nbsp;" + army.destroyer + "&nbsp;&nbsp;";
							
							if (tmp.length > 0) {
								html += "<tr>";
								html += "<td colspan=\"2\">";
								html += tmp;
								html += "</td>";
								html += "</tr>";
							}
										
							tmp = "";							
							var resources = transport.resources;						
							if (resources != null && resources.wood != null)
								tmp += "木头" + ":&nbsp;" + resources.wood + "&nbsp;&nbsp;";						
							
							if (resources != null && resources.food != null)
								tmp += "食物" + ":&nbsp;" + resources.food + "&nbsp;&nbsp;";
								
							if (resources != null && resources.iron != null)
								tmp += "黑铁石" + ":&nbsp;" + resources.iron + "&nbsp;&nbsp;";
								
							if (resources != null && resources.marble != null)
								tmp += "大理石" + ":&nbsp;" + resources.marble + "&nbsp;&nbsp;";
								
							if (resources != null && resources.gold != null)
								tmp += "黄金" + ":&nbsp;" + resources.gold + "&nbsp;&nbsp;";
							
							if (tmp.length > 0) {
								html += "<tr>";
								html += "<td colspan=\"2\">";
								html += tmp;
								html += "</td>";
								html += "</tr>";							
							}							
						}						
					});	
				}
				
				return html;
			}			
			
			function getSoldiersName(soldierName) {
				if (soldierName == "infantry")
					return "铁剑士";
					
				if (soldierName == "scout")
					return "侦察兵";
										
				if (soldierName == "musketman")
					return "火枪手";
					
				if (soldierName == "catapult")
					return "投石车";
					
				if (soldierName == "frigate")
					return "强弩舰";
					
				if (soldierName == "destroyer")
					return "火炮舰";
					
				return "";
			}
			
			function getBuildingName(buildingType) {
				switch (buildingType) {
					case 1:
						return "兵营";
						
					case 2:
						return "木头";
						
					case 3:
						return "仓库";
						
					case 4:
						return "港口";
						
					case 5:
						return "食物";
						
					case 6:
						return "大理石";
						
					case 7:
						return "黑铁";
						
					case 8:
						return "黄金";
						
					case 9:
						return "市场";
						
					case 10:
						return "市政厅";
						
					case 12:
						return "城墙";
						
					case 13:
						return "造船厂";
						
					case 14:
						return "地窖";
						
					case 16:
						return "箭塔";
						
					case 17:
						return "炮塔";
						
					default:
						return "";										
				}
			}
						
			function setOtherTown(json, townId) {
				var town = json.town;
				if (town == null)
					return;				
				
				var div = "towns";
				var buildings = town.buildings;
				var alliance = town.alliance;
				var resources = town.resources;
				var soldiers = town.soldiers;
				var heroInfo = town.hero_info;
				var battleQueues = town.battle_queue;
				var buildingQueues = town.building_queue;
				var transportQueues = town.transport_queue;
				var hero = town.hero_info;
												
				html = "";
				html += "<table width=\"640\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"1\" class=\"Table1\">";
				html += "<tr>";
				html += "<td width=\"10%\" align=\"center\" valign=\"middle\">基本信息</td>";
				html += "<td width=\"40%\">";				
				html += "<table width=\"94%\" border=\"0\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-left:5px\">";				
				if (town.is_capital == true) {
					html += "<tr>";
					html += "<td align=\"left\" width=\"34%\" height=\"25\">用户名: </td>";
					html += "<td>" + town.owner + "</td>";        
					html += "</tr>";
				}
				
				html += "<tr>";								
				html += "<td align=\"left\" width=\"34%\" height=\"25\">城市名称: </td>";
				if (town.is_capital == true)			        
					html += "<td style=\"color:#FF0000\">" + town.name + "</td>";
				else
					html += "<td>" + town.name + "</td>";
				 				        
				html += "</tr>";        
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">城市ID: </td>";
				html += "<td>" + town.id + "</td>";        
				html += "</tr>";
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">状态: </td>";				
				if (town.city_status == "normal")
					html += "<td>" + town.city_status + "</td>";
				else
					html += "<td style=\"color:#FF0000\">" + town.city_status + "</td>";
					        
				html += "</tr>";
				html += "<tr>";
				
				var resource_type = "";
				if (town.resource_type == 1)
					resource_type = "黄金";
					
				if (town.resource_type == 2)
					resource_type = "大理石";
					
				if (town.resource_type == 3)
					resource_type = "黑铁石";
				
				html += "<td align=\"left\" width=\"34%\" height=\"25\">资源类别: </td>";
				html += "<td>" + resource_type + "</td>";        
				html += "</tr>";
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">等级: </td>";
				html += "<td>" + town.level + "</td>";        
				html += "</tr>";
				html += "<tr>";
				
				var alliance_name = "";
				if (alliance != null)
					alliance_name = alliance.alliance_name;
				
				html += "<td align=\"left\" width=\"34%\" height=\"25\">联盟: </td>";
				html += "<td>" + alliance_name + "</td>";        
				html += "</tr>";
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">坐标: </td>";
				html += "<td>" + town.island_x + "," + town.island_y + "</td>";        
				html += "</tr>";												
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">维护量: </td>";
				html += "<td>" + town.presence_defenders + "</td>";        
				html += "</tr>";
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">侦察量: </td>";
				html += "<td>" + town.presence_scout + "</td>";        
				html += "</tr>";				
				html += "<tr>";
				html += "<td align=\"left\" width=\"34%\" height=\"25\">宝石: </td>";
				html += "<td>" + town.gems + "</td>";        
				html += "</tr>";											    			    
				html += "</table>";				
				html += "</td>";
				
				html += "<td width=\"10%\" align=\"center\" valign=\"middle\">资源</td>";
				html += "<td width=\"40%\" align=\"left\">";
								
				$.each(resources, function(idx, resource) {
					if (resource.resource_name == "wood") {							
						html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td valign=\"top\" align=\"center\">";							
						html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">木头</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + resource.resource_count + "/" + resource.max_volume + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
						html += "</tr>";
						html += "<tr>";
												
						var tmp = "";							
						$.each(buildings, function(idx, building) {
							if (building.building_type == 2) {
								var lines = building.lines;
								$.each(lines, function(idx, line) {
									if (line.status == "upgrading")											
										tmp += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, line.id, true) + "\">" + line.level + "</span>&nbsp;&nbsp;";											
									else
										tmp += "<span style=\"color:#000000\">" + line.level + "</span>&nbsp;&nbsp;";
								});						
							}								
						});
						
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">&nbsp;</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + tmp + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">&nbsp;</td>";							
						html += "</tr>";							
						html += "</table>";
						html += "</td>";
						html += "</tr>";
						html += "</table><br/>";
						return;						
					}
					
					if (resource.resource_name == "food") {							
						html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td valign=\"top\" align=\"center\">";							
						html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">食物</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + resource.resource_count + "/" + resource.max_volume + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
						html += "</tr>";
						html += "<tr>";
												
						var tmp = "";							
						$.each(buildings, function(idx, building) {
							if (building.building_type == 5) {
								var lines = building.lines;
								$.each(lines, function(idx, line) {
									if (line.status == "upgrading")											
										tmp += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, line.id, true) + "\">" + line.level + "</span>&nbsp;&nbsp;";											
									else
										tmp += "<span style=\"color:#000000\">" + line.level + "</span>&nbsp;&nbsp;";
								});						
							}								
						});
						
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">&nbsp;</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + tmp + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">&nbsp;</td>";							
						html += "</tr>";							
						html += "</table>";
						html += "</td>";
						html += "</tr>";
						html += "</table><br/>";
						return;					
					}													
							
					if (town.resource_type == 1) {
						if (resource.resource_name == "gold") {
							html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							html += "<tr>";
							html += "<td valign=\"top\" align=\"center\">";							
							html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							html += "<tr>";
							html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">黄金</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + resource.resource_count + "/" + resource.max_volume + "</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
							html += "</tr>";
							
							var tmp = "";							
							$.each(buildings, function(idx, building) {
								if (building.building_type == 8) {
									var lines = building.lines;
									$.each(lines, function(idx, line) {
										if (line.status == "upgrading")											
											tmp += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, line.id, true) + "\">" + line.level + "</span>&nbsp;&nbsp;";											
										else
											tmp += "<span style=\"color:#000000\">" + line.level + "</span>&nbsp;&nbsp;";
									});						
								}								
							});
																				
							html += "<tr>";
							html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">&nbsp;</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + tmp + "</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"30%\">&nbsp;</td>";							
							html += "</tr>";													
							html += "</table>";
							html += "</td>";
							html += "</tr>";
							html += "</table><br/>";							
							return;
						}							
					}
					
					if (town.resource_type == 2) {
						if (resource.resource_name == "marble") {
							html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							html += "<tr>";
							html += "<td valign=\"top\" align=\"center\">";							
							html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							html += "<tr>";
							html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">大理石</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + resource.resource_count + "/" + resource.max_volume + "</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
							html += "</tr>";	
							
							var tmp = "";							
							$.each(buildings, function(idx, building) {
								if (building.building_type == 6) {
									var lines = building.lines;
									$.each(lines, function(idx, line) {
										if (line.status == "upgrading")											
											tmp += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, line.id, true) + "\">" + line.level + "</span>&nbsp;&nbsp;";											
										else
											tmp += "<span style=\"color:#000000\">" + line.level + "</span>&nbsp;&nbsp;";
									});						
								}								
							});
									
							html += "<tr>";	
							html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">&nbsp;</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + tmp + "</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"30%\">&nbsp;</td>";							
							html += "</tr>";			
							html += "</table>";
							html += "</td>";
							html += "</tr>";
							html += "</table><br/>";
							return;
						}						
					}
					
					if (town.resource_type == 3) {
						if (resource.resource_name == "iron") {
							html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							html += "<tr>";
							html += "<td valign=\"top\" align=\"center\">";							
							html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							html += "<tr>";
							html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">黑铁石</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + resource.resource_count + "/" + resource.max_volume + "</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
							html += "</tr>";
							
							var tmp = "";							
							$.each(buildings, function(idx, building) {
								if (building.building_type == 7) {
									var lines = building.lines;
									$.each(lines, function(idx, line) {
										if (line.status == "upgrading")											
											tmp += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, line.id, true) + "\">" + line.level + "</span>&nbsp;&nbsp;";											
										else
											tmp += "<span style=\"color:#000000\">" + line.level + "</span>&nbsp;&nbsp;";
									});						
								}								
							});
																			
							html += "<tr>";	
							html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">&nbsp;</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + tmp + "</td>";
							html += "<td align=\"left\" valign=\"top\" width=\"30%\">&nbsp;</td>";							
							html += "</tr>";														
							html += "</table>";
							html += "</td>";
							html += "</tr>";
							html += "</table><br/>";
							return;							
						}							
					}
				});							
				
				$.each(resources, function(idx, resource) {
					if (town.resource_type != 1 && resource.resource_name == "gold") {			
						html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td valign=\"top\" align=\"center\">";							
						html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">黄金</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + resource.resource_count + "/" + resource.max_volume + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
						html += "</tr>";																			
						html += "</table>";
						html += "</td>";
						html += "</tr>";
						html += "</table><br/>";							
						return;
					}
				
					if (town.resource_type != 2 && resource.resource_name == "marble") {
						html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td valign=\"top\" align=\"center\">";							
						html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">大理石</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + resource.resource_count + "/" + resource.max_volume + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
						html += "</tr>";											
						html += "</table>";
						html += "</td>";
						html += "</tr>";
						html += "</table><br/>";
						return;
					}
					
					if (town.resource_type != 3 && resource.resource_name == "iron") {
						html += "<table width=\"98%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td valign=\"top\" align=\"center\">";							
						html += "<table width=\"95%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td align=\"left\" valign=\"top\" width=\"25%\" height=\"20\">黑铁石</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"45%\">" + resource.resource_count + "/" + resource.max_volume + "</td>";
						html += "<td align=\"left\" valign=\"top\" width=\"30%\">" + resource.increase_per_hour + "/h</td>";
						html += "</tr>";																					
						html += "</table>";
						html += "</td>";
						html += "</tr>";
						html += "</table><br/>";
						return;							
					}				
				});			
								
				html += "</td>";
				html += "</tr>";
								
				var tr = true;				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 10) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<span style=\"color:#000000\">" + getBuildingName(building.building_type) + "</span>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"92%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";			    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;						
			    	}					
				});
					
				$.each(buildings, function(idx, building) {
					if (building.building_type == 9) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<span style=\"color:#000000\">" + getBuildingName(building.building_type) + "</span>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">售量: </td><td>" + property.left_capacity + "/" + property.capacity + "</td></tr>";			    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;						
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 3) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<span style=\"color:#000000\">" + getBuildingName(building.building_type) + "</span>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">存量: </td><td>" + property.capacity + "</td></tr>";			    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 4) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<span style=\"color:#000000\">" + getBuildingName(building.building_type) + "</span>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">运量: </td><td>" + property.fleet_quota + "/次</td></tr>";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">有效: </td><td>" + property.available_fleet + "次</td></tr>";			    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 1) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<span style=\"color:#000000\">" + getBuildingName(building.building_type) + "</span>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">训练速度: </td><td>" + property.reduce_time_rate + "%</td></tr>";
			    		
			    		$.each(soldiers, function(idx, soldier) {
			    			var name = soldier.name;
			    			var count = soldier.count;
			    						    			
			    			if (name == "infantry" || name == "scout" || name == "musketman" || name == "catapult") {
			    				html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">" + getSoldiersName(name) + ": </td><td>" + count + "</td></tr>";
			    				return;			    			
			    			}			    			
			    		});
			    					    					    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 13) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<span style=\"color:#000000\">" + getBuildingName(building.building_type) + "</span>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">训练速度: </td><td>" + property.reduce_time_rate + "%</td></tr>";
			    		
			    		$.each(soldiers, function(idx, soldier) {
			    			var name = soldier.name;
			    			var count = soldier.count;
			    			
			    			if (name == "frigate" || name == "destroyer") {
			    				html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">" + getSoldiersName(name) + ": </td><td>" + count + "</td></tr>";
			    				return;			    			
			    			}			    					    			
			    		});
			    					    					    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 12) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<span style=\"color:#000000\">" + getBuildingName(building.building_type) + "</span>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td colspan=\"4\">" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    				    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">防御: </td><td colspan=\"4\">" + property.defense + "</td></tr>";
			    		
			    		var towers = building.towers;
			    		if (towers != null) {
			    			var arrays = [ 1, 1 ];
			    			$.each(towers, function(idx, tower) {
			    				var defense = tower.defense;
			    				var level = tower.level;
			    				var id = tower.id;
			    				var type = tower.type;
			    				var status = tower.status;
			    				var attack = tower.attack;
			    				var name = "";
			    				var tmp = "";
			    					
				    			if (tower.type == 16) {
				    				name = getBuildingName(tower.type);
				    				name += arrays[0];
				    				arrays[0]++;				    				
				    			}
				    			
				    			if (tower.type == 17) {
				    				name = getBuildingName(tower.type);
				    				name += arrays[1];
				    				arrays[1]++;				    				   			
				    			}
				    			
				    			if (status == "upgrading")
				    				tmp = "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, id, true) + "\">" + name + "</span>";			    			
				    			else
				    				tmp = "<a href=\"#\" onclick=\"upgradeBuilding(" + id + ");return false;\" class=\"AdminToolsLink1\">" + name + "</a>";
				    			
				    			html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">" + tmp + "</td><td width=\"15%\">攻击 </td><td>" + attack + "</td><td width=\"15%\">防御 </td><td>" + defense + "</td></tr>";				    			
				    			html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">" + type + "</td><td width=\"15%\">等级</td><td colspan=\"3\">" + level + "</td></tr>";				    			
				    		});
			    		}			    					    		
			    					    					    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				$.each(buildings, function(idx, building) {
					if (building.building_type == 14) {
						if (tr)
							html += "<tr>";
						
						html += "<td width=\"10%\">";
						html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						html += "<tr>";
						html += "<td height=\"20\">";				
			    					    		
			    		if (building.status == "upgrading")
			    			html += "<span style=\"color:#FF0000\" title=\"" + getFinishTime(buildingQueues, building.id, false) + "\">" + getBuildingName(building.building_type) + "</span>";											
						else
							html += "<span style=\"color:#000000\">" + getBuildingName(building.building_type) + "</span>";
			    		 					    		
			    		html += "</td>";
			    		html += "</tr>";
			    		html += "<tr><td height=\"20\" align=\"center\">" + building.building_type + "</td></tr>";
			    		html += "</table>";
			    		html += "</td>";	    		
			    		html += "<td width=\"40%\">";
			    		html += "<table width=\"94%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">等级: </td><td>" + building.level + "/40" + "</td></tr>";
			    		
			    		var property = building.property;			    					    		
			    		html += "<tr><td align=\"left\" height=\"25\" width=\"34%\">存量: </td><td>" + property.safe_capacity + "</td></tr>";			    					    			    			    			
			    		html += "</table>";
			    		html += "</td>";
			    		
			    		if (!tr) {
							html += "</tr>";
							tr = true;
						} else
							tr = false;
							
						return;					
			    	}					
				});
				
				if (hero != null) {
					if (tr)
						html += "<tr>";
						
					var date = new Date(hero.restore_energy_at * 1000);
					var restoreEnergyAt = date.pattern("yyyy-MM-dd HH:mm:ss");
					
					date = new Date(hero.recovery_at * 1000);
					var recoveryAt = date.pattern("yyyy-MM-dd HH:mm:ss");
						
					html += "<td width=\"10%\">";
					html += "<table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
					html += "<tr>";
					html += "<td height=\"20\" align=\"center\">英雄</td>";
		    		html += "</tr>";		    		
		    		html += "</table>";
		    		html += "</td>";	    		
		    		html += "<td width=\"40%\" style=\"padding-left:3\">";
		    		html += "<table width=\"100%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
		    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">名称: </td><td>" + hero.name + "</td><td align=\"left\">" + hero.id + "</td></tr>";		    					    					    		
		    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">经验: </td><td>" + hero.experience + "/" + hero.next_level_exp + "</td><td align=\"left\">Lv: " + hero.level + "</td></tr>";
		    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">能量: </td><td colspan=\"2\">" + hero.energy + "/" + hero.max_energy + "</td></tr>";
		    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">攻击: </td><td>" + hero.attack + "/" + hero.total_attack + "</td><td align=\"left\">" + hero.init_attack + "</td></tr>";
		    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">防御: </td><td>" + hero.defense + "/" + hero.total_defense + "</td><td align=\"left\">" + hero.init_defense + "</td></tr>";
		    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">敏捷: </td><td>" + hero.intelligence + "/" + hero.total_intelligence + "</td><td align=\"left\">" + hero.init_intelligence + "</td></tr>";
		    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">智力: </td><td>" + hero.genius + "</td><td>&nbsp;</td></tr>";
		    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">能力点: </td><td>" + hero.ability_point + "</td><td>&nbsp;</td></tr>";
		    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">状态: </td><td colspan=\"2\">" + hero.status + "</td></tr>";	
		    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">活动: </td><td colspan=\"2\">" + hero.hero_city_effect + "</td></tr>";			
		    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">创建时间: </td><td colspan=\"2\">" + recoveryAt + "</td></tr>";
		    		html += "<tr><td align=\"left\" height=\"25\" width=\"25%\">恢复时间: </td><td colspan=\"2\">" + restoreEnergyAt + "</td></tr>";		    					    					    			    			    			
		    		html += "</table>";
		    		html += "</td>";
						
					if (!tr) {
						html += "</tr>";
						tr = true;
					} else
						tr = false;
				}
				
				if (!tr)
					html += "<td width=\"10%\">&nbsp;</td><td width=\"40%\">&nbsp;</td></tr>";
					
				html += "<tr><td align=\"center\" height=\"25\">事件</td>";
				html += "<td colspan=\"3\" align=\"left\">";
				html += "<table width=\"97%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
												
				var desc = "";
				desc += getBuildingDesc(buildings, buildingQueues);
				desc += getTrainingDesc(soldiers);
				desc += getBattleDesc(battleQueues);
				desc += getTransportDesc(transportQueues);
				
				if (desc.length == 0)
					html += "<tr><td>&nbsp;</td></tr>";
				else
					html += desc;
								
				html += "</table>";
				html += "</td>";				
				html += "</table><br/>";
				
				var divTown = "town_" + townId;
				if ($("#" + div).find("#" + divTown).length == 0) {
					html = "<div id=\"" + divTown + "\">" + html + "</div>";
					$("#" + div).append(html);				
				} else
					$("#" + divTown).html(html);								
			}
			
			function setOtherMessages(json, username, page) {
				var username = "";
				var tmp = "";					
				var type = -1;
				var sys = 0;
				var more = true;
				
				var messages = json.messages;
				if (messages != null) {
					$.each(messages, function(idx, message) {						
						var created_at = "";
						if (message.message_type != 5) {
							username = message.to;
							var date = new Date(message.created_at * 1000);
							created_at = date.pattern("yyyy-MM-dd HH:mm:ss");
						} else
							sys++;
						
						if (message.message_type != type) {
							tmp += "<table width=\"500\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
							tmp += "<tr>";
							tmp += "<td align=\"left\">";
							tmp += getMessageType(message.message_type);
							tmp += "</td>";
							if (more) {
								tmp += "<td align=\"right\">";
								tmp += "<a href=\"messages.html?username=" + username + "&page=1\" target=\"_blank\" class=\"AdminToolsLink2\">[更多]</a>";
								tmp += "</td>";
								more = false;							
							}
							
							tmp += "</tr>";
							tmp += "</table>";
							type = message.message_type;
						}
						
						tmp += "<table width=\"500\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"1\" class=\"Table1\">";
						tmp += "<tr>";
						
						if (message.message_type != 5)
							tmp += "<td width=\"60%\" height=\"30\" style=\"padding-left:5;padding-right:5\"><a href=\"#\" onclick=\"bodyShow('" + message.id + "');return false;\" class=\"AdminToolsLink1\">" + message.subject + "</a></td>";
						else
							tmp += "<td width=\"60%\" height=\"30\" style=\"padding-left:5;padding-right:5\"><a href=\"#\" onclick=\"bodyShow('s" + sys + "');return false;\" class=\"AdminToolsLink1\">" + message.subject + "</a></td>";
						
						tmp += "<td rowspan=\"2\" align=\"center\">";
						tmp += "<table width=\"180\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
						tmp += "<tr>";
						tmp += "<td align=\"center\" height=\"25\">" + message.from + " -> " + message.to + "</td>";
						tmp += "</tr>";
				        tmp += "<tr>";
				        tmp += "<td align=\"center\" height=\"25\">" + created_at + "</td>";
				        tmp += "</tr>";
				        tmp += "</table>";
				        tmp += "</td>";
				        tmp += "</tr>";
				        tmp += "<tr>";		            
				        tmp += "<td height=\"25\" style=\"padding-left:5;padding-right:5;\">" + message.to + "</td>";
				        tmp += "</tr>";
				        
				        var found = false;
				        for (var i = 0;i < OtherMessages.length;i++) {
				        	if (message.id == OtherMessages[i]) {
				        		found = true;
				        		break;		          
				        	}  
				        }
				        
				        var bodyId = "body_" + message.id;
				        if (message.message_type == 5)
				        	bodyId = "body_s" +  sys;
				        
				        if (!found)
				        	tmp += "<tr id=\"" + bodyId + "\" style=\"display:none\">";
				        else
				        	tmp += "<tr id=\"" + bodyId + "\">";
				        	
				        var body = "";
				        if (message.body != null) {
				        	body = message.body;
				        	body = body.replace(/\n/g, "<br/>");				        	
				        }
				        	
				        tmp += "<td height=\"25\" style=\"padding-left:5;padding-right:5;padding-top:5;padding-bottom:5;\" colspan=\"2\">" + body + "</td>";
				        tmp += "</tr>";
				        tmp += "</table>";
				        tmp += "<br />";	
					});
				}
				
				var html = "";				
				html += tmp;
				
				var div = "messages";				
			    $("#" + div).html(html);				
			}
			
			function bodyShow(id) {	
				var body = "#body_" + id;			
				if ($(body).css("display") == "none") {												
					$(body).show();					
					OtherMessages.push(id);					
				} else {
					$(body).hide();
					var index = -1;
			        for (var i = 0;i < OtherMessages.length;i++) {
			        	if (id == OtherMessages[i]) {
			        		index = i;
			        		break;		          
			        	}  
			        }
			        
			        if (index != -1)
			        	OtherMessages.splice(index, 1);            			            
				}				
			}
			
			function getMessageType(type) {
				switch (type) {
					case 0:
						return "玩家";
						
					case 1:
						return "系统";
						
					case 3:
						return "战斗";
						
					case 5:
						return "新闻";
						
					default:
						return "";		
				}			
			}
			
			function setOtherRanks(json) {
				var myrank = json.my_rank;
				var ranks = json.rank;
				if (ranks != null) {
					var html = "<table width=\"500\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">";
					html += "<tr><td align=\"left\">排行榜</td></tr>";					
					html += "</table>";
					html += "<table width=\"500\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"1\" class=\"Table1\">";					
					$.each(ranks, function(idx, rank) {						
						var color = "#000000";						
						if (myrank == rank.rank)
							color = "#FF0000";
												
						html += "<tr>";
						html += "<td height=\"30\" width=\"40\" align=\"center\"><span style=\"color:" + color + "\">" + rank.rank + "</span></td>";
						html += "<td height=\"30\" width=\"60\" align=\"center\"><span style=\"color:" + color + "\">" + rank.id + "</span></td>";
						html += "<td height=\"30\" width=\"130\" align=\"center\"><span style=\"color:" + color + "\">" + rank.username + "</td>";						
						html += "<td height=\"30\" width=\"85\" align=\"center\"><span style=\"color:" + color + "\">" + rank.score + "</td>";	
						html += "<td height=\"30\" align=\"center\"><span style=\"color:" + color + "\">" + rank.alliance_name + "</td>";
						html += "</tr>";																										
					});
					
					html += "</table>";					
					$("#ranks").html(html);					
				}			
			}
													
			start();
		</script>
	</body>
</html>